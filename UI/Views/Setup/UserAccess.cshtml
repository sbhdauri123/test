@{
    ViewBag.Title = "Servers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="dragoMain" id="userTableContainer">
    <div id="gridContainer" class="toolControlContainer tc-Main">
        <header>
            <h2>Security Setup</h2>
        </header>
        <div id="kGrid" class="toolControl">
        </div>
    </div>
</div>

<script src="~/Scripts/Greenhouse/common.js"></script>
<script type="text/javascript">

    $(function ()
    {
        var securityHub = $.connection.securityHub;

        //var dsServerTypes = LookupDataSourceCommaDelimit("ServerType");
        var dsMasterClients = GetDataSource("GetMasterClients", "MasterClientID", "MasterClientCode");
        dsMasterClients.fetch();
        var dsMasterAgencies = GetDataSource("GetMasterAgencies", "MasterAgencyID", "MasterAgencyCode");
        dsMasterAgencies.fetch();
        var tplData = kendo.template($("#tplDataDisplayName").html());
        var tplcheck = kendo.template($("#tplCheck").html());


        $("#kGrid").kendoGrid({
            dataSource: ServersDataSource()
            , columns: [
                 {
                     command: [
                          { name: "edit", text: "", template: "<a class='btn-small lnkEdit'><i class='fa fa-pencil-square-o grid-edit-link'></i></a>", width: 10 },
                          { name: "destroy", template: "<a class='btn-small lnkDelete'><i class='fa fa-times grid-edit-link'></i></a>", text: "", width: 10 }
                     ]
                        , width: 120
                        , title: "<button id='btnAdd' class='btn btn-primary'>Create User</button>"
                 }
                , { field: "id" }
                , { field: "MasterClientID", title: "Master Client", template: "#=fnTemplateData('dsMasterClients', MasterClientID) #", filterable: { ui: masterclientsFilter } }
                , { field: "MasterAgencyID", title: "Master Agency", template: "#=fnTemplateData('dsMasterAgencies', MasterAgencyID) #", filterable: { ui: masteragenciesFilter } }
                , { field: "Username", title: "Name", width: "200px" }
                //, { field: "CreatedDate", title: "Created Date", template: "#=kendo.toString(CreatedDate, 'd')#", width: "150px" }
                , { hidden: true, field: "LastUpdated", title: "Updated", template: "#=kendo.toString(LastUpdated, 'd')#", width: "150px" }
            ]
            , editable: {
                mode: "popup"
                       , edit: true
                       , destroy: true
                       , create: true
                       , confirmation: "Are you sure you want to delete this?"
                       , template: $("#tplUserAccess").html()
            }
            , dataBound: OnGridDataBind
            , edit: function (evt)
            {
                var container = evt.container;
                container.width("480").height("330");

                var win = container.data("kendoWindow");
                var title = (!evt.model.GUID) ? "Add New User" : "Editing [" + evt.model.Username + "]";
                win.title(title);
                win.center().open();

                var ddlMasterClients = container.find("#MasterClientID");
                ddlMasterClients.kendoDropDownList({
                    dataSource: dsMasterClients
                    , dataTextField: "Name"
                    , dataValueField: "ID"
                    , optionLabel: "--Select a Master Client--"
                });

                var ddlMasterAgencies = container.find("#MasterAgencyID"); //
                ddlMasterAgencies.kendoDropDownList({
                    dataSource: dsMasterAgencies
                    , dataTextField: "Name"
                    , dataValueField: "ID"
                    , optionLabel: "--Select a Master Agency--"
                });

                SetValidation(container);

                evt.container.find(".k-grid-cancel").on("click", function (e)
                {
                    evt.sender.cancelChanges();
                    evt.sender.dataSource.read();
                });
            }
            , save: function (evt)
            {
                var container = evt.container;
                var validator = container.find(".lyrEdit").data("kendoValidator");
                if (!validator.validate())
                    evt.preventDefault();

            }
           , sortable: { mode: "multiple" }
           , columnMenu: gridColumMenuOptions
           , filterable: gridFilterOptions
           , resizable: true
           , pageable: true
           , scrollable: true
        }).data("kendoGrid")
        .wrapper.height("600px");

        function ServersDataSource()
        {
        	return new kendo.data.DataSource({
        		type: "signalr",
        		autoSync: false,
                transport: {
                	signalr: {
                		promise:mainHub.ConnectionHub.start(),
                		hub: securityHub,
                		server: {
                		    read: "read"
							, create: "create"
							, destroy: "destroy"
							, update: "update"
                		},
                		client: {
                			read: "read"
							, create: "create"
							, destroy: "destroy"
							, update: "update"
                		}
                	},
                	parameterMap:function(option,type)
                	{
                		if (type === "create")
                		{
                			option.GUID = kendo.guid();
                		}else if (type === "destroy")
                		{
                		    //option.SettingsFields = option.SettingsFields.split(",");
                		    //option.SourceFileMetadataFields = option.SourceFileMetadataFields.split(",");
                		    //option.CustomPropertiesFields = option.CustomPropertiesFields.split(",");

                		}
                		return option;
                	}
                }//end transport
               , schema: {
                   model: {
                       id: "id"
                               , fields: {
                                   id: { type: "string" }
                                   , MasterClientID: { type: "number" }
                                   , MasterAgencyID: { type: "number" }
                                   , Username: { type: "string" }
                                   //, CreatedDate: { type: "date", format: "MM/dd/yyyy" }
                                   , LastUpdated: { type: "date", format: "MM/dd/yyyy", parse: function (value) { return parseUTCDate(value) } }
                               }
                   }
                   ,parse: function (response) {
                       var users = [];
                       for (var i = 0; i < response.length; i++) {
                           var user = {
                               id: response[i].Username + "_" + response[i].MasterClientID + "_" + response[i].MasterAgencyID,
                               MasterClientID: response[i].MasterClientID,
                               MasterAgencyID: response[i].MasterAgencyID,
                               Username: response[i].Username,
                               CreatedDate: response[i].CreatedDate,
                               LastUpdated: response[i].LastUpdated
                           };
                           users.push(user);
                       }
                       return users;
                    }

                   //, total: function (data) { return data.length; }
               }
               , requestEnd: function (e) {
                   kendo.ui.progress($(".k-grid"), false);
               }
               , requestStart: function (e) {
                   kendo.ui.progress($(".k-grid:visible"), true);
               }
               , serverPaging: false
               , serverSorting: false
               , serverFiltering: false
               , pageSize: 20
            });//end dataSource
        }//end DataSource()

        function SetValidation(container)
        {
            var validator = container.find(".lyrEdit").kendoValidator({
                rules: {
                    required: function (input)
                    {
                        if (input.is("[class*='required']"))
                        {
                            if (!$.trim(input.val()))
                                return false;
                            return true;
                        }
                        return true;
                    }
                }//end rules
                , messages: {
                    required: "* required"
                }
                , validateOnBlur: false
            });
        }

        function masterclientsFilter(ele) {
            ele.kendoDropDownList({
                dataSource: dsMasterClients
               , dataTextField: "Name"
               , dataValueField: "ID"
               , optionLabel: "--Select--"
            }).data("kendoDropDownList").wrapper.width("250px");
        }

        function masteragenciesFilter(ele) {
            ele.kendoDropDownList({
                dataSource: dsMasterAgencies
               , dataTextField: "Name"
               , dataValueField: "ID"
               , optionLabel: "--Select--"
            }).data("kendoDropDownList").wrapper.width("250px");
        }

        fnTemplateData = function (dsName, idField) {
            var ds = eval(dsName);
            var htm = tplData({ DataSource: ds.data(), ID: idField });
            return htm;
        }

        fnTemplateCheck = function (value) {
            //var isChecked = (value == 0);
            var htm = tplcheck({
                Val: value //isChecked
            });
            return htm;
        }

    });

</script>
<script id="tplUserAccess" type="text/html">

    <div id='lyrEditSourceFiles' class=" lyrEdit">

        <div class="control-group">
            <label for="MasterClientID" class="control-label">Master Client:</label>
            <div class="controls"><input type="text" id="MasterClientID" style="width: 400px" class="required form-control" name="MasterClientID" data-bind="value: MasterClientID" /></div>
        </div>
        <div class="control-group">
            <label for="MasterAgencyID" class="control-label">Master Agency:</label>
            <div class="controls"><input id="MasterAgencyID" style="width:430px" class="required form-control" name="MasterAgencyID" data-bind="value: MasterAgencyID" /></div>
        </div>
        <div class="control-group" id="timesection">
            <label for="Username" class="control-label">User Name:</label>
            <div class="controls">
                <input type="text" class="required form-control" id="Username" name="Username" style="width:400px" />
            </div>
        </div>

    </div>

</script>
@*<script id="tplCheck" type="text/x-kendo-template">
        #
        var iconClass = "icon-ok";
        if(!Val) {
        iconClass = "icon-remove";
        }
        #
        <div style='text-align:center'><i class="#=iconClass#">&nbsp;</i></div>
    </script>*@

<script id="tplCheck" type="text/x-kendo-template">
    #
    var iconClass = "glyphicon glyphicon-ok green";
    if(!Val) {
    iconClass = "glyphicon glyphicon-remove red";
    }
    #
    <div style='text-align:center'><i class="#=iconClass#">&nbsp;</i></div>
</script>

<script id="tplDataDisplayName" type="text/x-kendo-template">
    <div>
        # var obj = $.grep(DataSource, function(ele,id){return ele.ID == ID});
        if(obj.length == 1){
        #
        #=obj[0].Name#
        #}#
    </div>
</script>